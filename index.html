<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Garantía Total — Dashboard de Ingresos (Cascada)</title>
  <meta name="description" content="Tablero estático con KPIs, cascada de ingresos y desgloses por responsables y canales. Datos embebidos desde la base de conocimiento (oct-2025)." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body { height: 100%; }
    .card { border-radius: 1rem; background: white; box-shadow: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04); }
    .muted { color: #6b7280; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .sticky-thead thead { position: sticky; top: 0; background: white; }
      .kpi .label{font-size:.9rem;color:#6b7280}
    .kpi .value{font-size:1.875rem;line-height:2.25rem;font-weight:600}
    .kpi .sub{font-size:.75rem;color:#6b7280}
    .kpi-icon{width:36px;height:36px;border-radius:12px;display:flex;align-items:center;justify-content:center}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 border-b">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-emerald-600 flex items-center justify-center text-white font-bold">GT</div>
        <div>
          <h1 class="text-xl font-semibold">Dashboard de Ingresos — Cascada</h1>
          <p class="text-sm muted">Garantías Extendidas | Reconocimiento lineal: <span class="mono">$6.250</span> / póliza / mes</p>
        </div>
      </div>
      <div class="text-xs muted">Corte: <span id="corte"></span> · Rango: <span id="rango"></span></div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- KPIs macro (row 1) -->
    <section id="kpiRow1" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <div class="card p-5 kpi">
        <div class="flex items-start justify-between">
          <div class="label">Ingreso realizado (hasta fin de mes previo)</div>
          <div class="kpi-icon bg-emerald-50 text-emerald-700" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M12 8c-2.21 0-4 1.343-4 3s1.79 3 4 3 4 1.343 4 3-1.79 3-4 3m0-12V4m0 16v-1"/></svg>
          </div>
        </div>
        <div id="kpiRealizado" class="value mt-2">—</div>
        <div id="kpiRealizadoNote" class="sub mt-1">—</div>
      </div>
      <div class="card p-5 kpi">
        <div class="flex items-start justify-between">
          <div class="label">Backlog (desde mes actual)</div>
          <div class="kpi-icon bg-sky-50 text-sky-700" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75"><path stroke-linecap="round" stroke-linejoin="round" d="M3 7h14M3 12h18M3 17h10"/></svg>
          </div>
        </div>
        <div id="kpiBacklog" class="value mt-2">—</div>
        <div id="kpiBacklogNote" class="sub mt-1">—</div>
      </div>
      <div class="card p-5 kpi">
        <div class="flex items-start justify-between">
          <div class="label">Run‑rate mes actual</div>
          <div class="kpi-icon bg-indigo-50 text-indigo-700" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.75" d="M3 12h6l4 8 4-16 4 8"/></svg>
          </div>
        </div>
        <div id="kpiRunRate" class="value mt-2">—</div>
        <div class="sub mt-1">Pólizas activas: <span id="kpiActivas"></span></div>
      </div>
      <div class="card p-5 kpi">
        <div class="flex items-start justify-between">
          <div class="label">Tasa de cancelación (acumulada)</div>
          <div class="kpi-icon bg-rose-50 text-rose-700" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v4m0 4h.01M10.29 3.86l-7.4 12.84A2 2 0 004.53 20h14.94a2 2 0 001.64-3.3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>
          </div>
        </div>
        <div id="kpiCancelRate" class="value mt-2">—</div>
        <div class="sub mt-1"># canceladas: <span id="kpiCancelCount"></span> / total: <span id="kpiTotalPolicies"></span></div>
      </div>
    </section>

    <!-- KPIs secundarios (row 2) -->
    <section id="kpiRow2" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card p-5 kpi">
        <div class="flex items-start justify-between">
          <div class="label">Mes pico (ingreso)</div>
          <div class="kpi-icon bg-amber-50 text-amber-700" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75"><path stroke-linecap="round" stroke-linejoin="round" d="M3 17l6-6 4 4 7-7"/></svg>
          </div>
        </div>
        <div id="kpiPeak" class="value mt-2">—</div>
      </div>
      <div class="card p-5 kpi">
        <div class="flex items-start justify-between">
          <div class="label">Mix de plazos (ventas)</div>
          <div class="kpi-icon bg-cyan-50 text-cyan-700" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h10M4 18h6"/></svg>
          </div>
        </div>
        <div id="kpiMix" class="value mt-2">—</div>
        <div class="sub mt-1" id="kpiMixNote"></div>
      </div>
      <div class="card p-5 kpi">
        <div class="flex items-start justify-between">
          <div class="label">Activas mes actual por plazo</div>
          <div class="kpi-icon bg-teal-50 text-teal-700" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-6-6h12"/></svg>
          </div>
        </div>
        <div id="kpiActivasPlazo" class="value mt-2">—</div>
        <div class="sub mt-1" id="kpiActivasPlazoNote"></div>
      </div>
    </section>

    <!-- Trend macro -->
    <section id="chartsSection" class="grid md:grid-cols-2 gap-4">
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-medium">Ingresos mensuales</h3>
          <div class="text-xs muted" id="ingresosRange">—</div>
        </div>
        <canvas id="ingresosChart" height="220"></canvas>
      </div>
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-medium">Pólizas: ventas y cancelaciones</h3>
          <div class="text-xs muted" id="ventasRange">—</div>
        </div>
        <canvas id="ventasChart" height="220"></canvas>
      </div>
    </section>

    <!-- Micro: desgloses del mes actual -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="card p-4 overflow-hidden">
        <div class="flex items-center justify-between">
          <h3 class="font-medium">Desglose por Responsable (mes actual)</h3>
          <div class="text-xs muted" id="mesActual"></div>
        </div>
        <div class="overflow-auto max-h-[360px]">
          <table class="w-full text-sm sticky-thead">
            <thead>
              <tr>
                <th class="text-left p-2">Responsable GT</th>
                <th class="text-left p-2">Responsable Bci</th>
                <th class="text-right p-2">Pólizas</th>
                <th class="text-right p-2">Ingreso</th>
              </tr>
            </thead>
            <tbody id="respBody"></tbody>
          </table>
        </div>
      </div>
      <div class="card p-4 overflow-hidden">
        <div class="flex items-center justify-between">
          <h3 class="font-medium">Top canales (mes actual)</h3>
          <div class="text-xs muted" id="mesActual2"></div>
        </div>
        <div class="overflow-auto max-h-[360px]">
          <table class="w-full text-sm sticky-thead">
            <thead>
              <tr>
                <th class="text-left p-2">Nombre del Canal</th>
                <th class="text-right p-2">Pólizas</th>
                <th class="text-right p-2">Ingreso</th>
              </tr>
            </thead>
            <tbody id="dealerBody"></tbody>
          </table>
          <p class="text-xs muted mt-2">Fuente: Glosa "Nombre del Canal" (Ventas Acumuladas).</p>
        </div>
      </div>
    </section>

    <!-- Cascada completa -->
    <section id="cascadaSection" class="card p-4">
      <div class="flex items-center justify-between"><h3 class="font-medium">Cascada por mes (historia + proyección cartera vigente)</h3></div>
      <div class="overflow-auto max-h-[420px] mt-2">
        <table class="w-full text-sm sticky-thead">
          <thead>
            <tr>
              <th class="text-left p-2">Mes</th>
              <th class="text-right p-2">Ingreso</th>
              <th class="text-right p-2">Activas</th>
              <th class="text-right p-2">Ventas</th>
              <th class="text-right p-2">Cancelaciones</th>
            </tr>
          </thead>
          <tbody id="cascadaBody"></tbody>
        </table>
      </div>
    </section>

    <footer class="text-xs muted">
      <p>Hecho para <strong>Garantía Total</strong>. Datos embebidos al <span id="dataDate"></span>. Supuestos: precio 12m = $75.000; 24m = $150.000; reconocimiento lineal = $6.250/mes; cancelaciones cortan ingreso desde el mes de <em>FECHA_FIN</em> (excluyente).</p>
    </footer>
  </main>

<script>
  // ==== Datos embebidos desde la base de conocimiento (oct-2025) ====
  window.__DATA__ = {"current_month": "2025-10", "series": {"months": ["02/2025", "03/2025", "04/2025", "05/2025", "06/2025", "07/2025", "08/2025", "09/2025", "10/2025", "11/2025", "12/2025", "01/2026", "02/2026", "03/2026", "04/2026", "05/2026", "06/2026", "07/2026", "08/2026", "09/2026", "10/2026", "11/2026", "12/2026", "01/2027", "02/2027", "03/2027", "04/2027", "05/2027", "06/2027", "07/2027", "08/2027", "09/2027", "10/2027"], "ingreso": [50000, 68750, 168750, 343750, 893750, 1568750, 2400000, 2950000, 3168750, 3168750, 3168750, 3168750, 3168750, 3168750, 3168750, 3168750, 3168750, 3168750, 3100000, 3068750, 2931250, 2931250, 2931250, 2931250, 2931250, 2856250, 2775000, 2600000, 2350000, 2143750, 1643750, 868750, 175000], "activas": [8, 11, 27, 55, 143, 251, 384, 472, 507, 507, 507, 507, 507, 507, 507, 507, 507, 507, 496, 491, 469, 469, 469, 469, 469, 457, 444, 416, 376, 343, 263, 139, 28], "ventas": [8, 3, 17, 31, 93, 121, 157, 118, 35, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], "cancelaciones": [2, 0, 1, 3, 5, 13, 25, 31, 0, 0, 0, 0, 0, 0, 0, 0, 0, 8, 0, 0, 0, 0, 0, 0, 6, 1, 12, 16, 16, 16, 8, 0, 0]}, "summary": {"realized": 8443750, "backlog": 68556250, "run_rate": 3168750, "active_now": 507, "cancel_rate": 0.136986301369863, "cancel_count": 80, "total_policies": 584, "peak_month": "2025-10", "peak_ingreso": 3168750, "peak_activas": 507, "mix_plazo": {"24": 547, "12": 40}, "actives_plazo_current": {"24": 469, "12": 38}}, "tables": {"responsables_mes_actual": [{"gt": "Paola Crisosto", "bci": "Aldo", "polizas": 107, "ingreso": 668750}, {"gt": "Xiomara Flores", "bci": "Marcela", "polizas": 94, "ingreso": 587500}, {"gt": "Gloria Ceron", "bci": "Aldo", "polizas": 93, "ingreso": 581250}, {"gt": "Jeannette Guerrero", "bci": "Elsa", "polizas": 56, "ingreso": 350000}, {"gt": "Jeannette Guerrero", "bci": "Alejandra", "polizas": 54, "ingreso": 337500}, {"gt": "Jeannette Guerrero", "bci": "Pamela", "polizas": 45, "ingreso": 281250}, {"gt": "Claudia Alarcon", "bci": "Marisel", "polizas": 30, "ingreso": 187500}, {"gt": "Nelson Mella", "bci": "Aldo", "polizas": 28, "ingreso": 175000}], "canal_mes_actual": [{"canal": "E. Kovacs", "polizas": 153, "ingreso": 956250}, {"canal": "Maritano Y Ebensperger", "polizas": 36, "ingreso": 225000}, {"canal": "Guillermo Morales Ltda", "polizas": 34, "ingreso": 212500}, {"canal": "Automotriz Bilbao Ortega", "polizas": 32, "ingreso": 200000}, {"canal": "Ek2 Spa", "polizas": 28, "ingreso": 175000}, {"canal": "Servicios Automotriz Ansar Spa", "polizas": 25, "ingreso": 156250}, {"canal": "Automotriz Santa Maria", "polizas": 21, "ingreso": 131250}, {"canal": "Promotorschile", "polizas": 20, "ingreso": 125000}, {"canal": "Autoplus Spa", "polizas": 19, "ingreso": 118750}, {"canal": "Mediterraneo Automotores S.A.", "polizas": 19, "ingreso": 118750}, {"canal": "Mdl Autos", "polizas": 14, "ingreso": 87500}, {"canal": "Garrido Autos", "polizas": 14, "ingreso": 87500}, {"canal": "Compra Justa", "polizas": 13, "ingreso": 81250}, {"canal": "Rr Motors", "polizas": 10, "ingreso": 62500}, {"canal": "Piretta Automobile", "polizas": 8, "ingreso": 50000}, {"canal": "Tecnocid", "polizas": 7, "ingreso": 43750}, {"canal": "Garcia Y Blu", "polizas": 6, "ingreso": 37500}, {"canal": "Automotriz Egaña", "polizas": 5, "ingreso": 31250}, {"canal": "Automotriz Civas", "polizas": 5, "ingreso": 31250}], "cascada_mensual": [{"label": "02/2025", "ingreso": 50000, "activas": 8, "ventas": 8, "cancelaciones": 2}, {"label": "03/2025", "ingreso": 68750, "activas": 11, "ventas": 3, "cancelaciones": 0}, {"label": "04/2025", "ingreso": 168750, "activas": 27, "ventas": 17, "cancelaciones": 1}, {"label": "05/2025", "ingreso": 343750, "activas": 55, "ventas": 31, "cancelaciones": 3}, {"label": "06/2025", "ingreso": 893750, "activas": 143, "ventas": 93, "cancelaciones": 5}, {"label": "07/2025", "ingreso": 1568750, "activas": 251, "ventas": 121, "cancelaciones": 13}, {"label": "08/2025", "ingreso": 2400000, "activas": 384, "ventas": 157, "cancelaciones": 25}, {"label": "09/2025", "ingreso": 2950000, "activas": 472, "ventas": 118, "cancelaciones": 31}, {"label": "10/2025", "ingreso": 3168750, "activas": 507, "ventas": 35, "cancelaciones": 0}, {"label": "11/2025", "ingreso": 3168750, "activas": 507, "ventas": 0, "cancelaciones": 0}, {"label": "12/2025", "ingreso": 3168750, "activas": 507, "ventas": 0, "cancelaciones": 0}, {"label": "01/2026", "ingreso": 3168750, "activas": 507, "ventas": 0, "cancelaciones": 0}, {"label": "02/2026", "ingreso": 3168750, "activas": 507, "ventas": 0, "cancelaciones": 0}, {"label": "03/2026", "ingreso": 3168750, "activas": 507, "ventas": 0, "cancelaciones": 0}, {"label": "04/2026", "ingreso": 3168750, "activas": 507, "ventas": 0, "cancelaciones": 0}, {"label": "05/2026", "ingreso": 3168750, "activas": 507, "ventas": 0, "cancelaciones": 0}, {"label": "06/2026", "ingreso": 3168750, "activas": 507, "ventas": 0, "cancelaciones": 0}, {"label": "07/2026", "ingreso": 3168750, "activas": 507, "ventas": 0, "cancelaciones": 8}, {"label": "08/2026", "ingreso": 3100000, "activas": 496, "ventas": 0, "cancelaciones": 0}, {"label": "09/2026", "ingreso": 3068750, "activas": 491, "ventas": 0, "cancelaciones": 0}, {"label": "10/2026", "ingreso": 2931250, "activas": 469, "ventas": 0, "cancelaciones": 0}, {"label": "11/2026", "ingreso": 2931250, "activas": 469, "ventas": 0, "cancelaciones": 0}, {"label": "12/2026", "ingreso": 2931250, "activas": 469, "ventas": 0, "cancelaciones": 0}, {"label": "01/2027", "ingreso": 2931250, "activas": 469, "ventas": 0, "cancelaciones": 0}, {"label": "02/2027", "ingreso": 2931250, "activas": 469, "ventas": 0, "cancelaciones": 6}, {"label": "03/2027", "ingreso": 2856250, "activas": 457, "ventas": 0, "cancelaciones": 1}, {"label": "04/2027", "ingreso": 2775000, "activas": 444, "ventas": 0, "cancelaciones": 12}, {"label": "05/2027", "ingreso": 2600000, "activas": 416, "ventas": 0, "cancelaciones": 16}, {"label": "06/2027", "ingreso": 2350000, "activas": 376, "ventas": 0, "cancelaciones": 16}, {"label": "07/2027", "ingreso": 2143750, "activas": 343, "ventas": 0, "cancelaciones": 16}, {"label": "08/2027", "ingreso": 1643750, "activas": 263, "ventas": 0, "cancelaciones": 0}, {"label": "09/2027", "ingreso": 868750, "activas": 139, "ventas": 0, "cancelaciones": 0}, {"label": "10/2027", "ingreso": 175000, "activas": 28, "ventas": 0, "cancelaciones": 0}]}};

  // ==== Utilidades ====
  const CLP = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });
  const PCT = new Intl.NumberFormat('es-CL', { style: 'percent', minimumFractionDigits: 1, maximumFractionDigits: 1 });
  const fmtInt = (n) => new Intl.NumberFormat('es-CL').format(n);

  function setText(id, value){ const el = document.getElementById(id); if(el) el.textContent = value; }
  function monthLabelYYYYMM(key){ const [y,m] = key.split('-'); return `${m}/${y}`; }

  // ==== Render KPIs ====
  const D = window.__DATA__;
  const months = D.series.months; // 'mm/yyyy'
  const currentKey = D.current_month; // 'YYYY-MM'
  const currentLabel = monthLabelYYYYMM(currentKey);

  // Cabecera
  setText('corte', new Date('2025-10-03').toLocaleDateString('es-CL'));
  setText('rango', `${months[0]} – ${months[months.length-1]}`);
  setText('dataDate', '03/oct/2025');

  // KPIs
  setText('kpiRealizado', CLP.format(D.summary.realized));
  setText('kpiRealizadoNote', `Hasta ${monthLabelYYYYMM('2025-09')}`);
  setText('kpiBacklog', CLP.format(D.summary.backlog));
  setText('kpiBacklogNote', `Desde ${currentLabel}`);
  setText('kpiRunRate', CLP.format(D.summary.run_rate));
  setText('kpiActivas', fmtInt(D.summary.active_now));
  setText('kpiCancelRate', PCT.format(D.summary.cancel_rate));
  setText('kpiCancelCount', fmtInt(D.summary.cancel_count));
  setText('kpiTotalPolicies', fmtInt(D.summary.total_policies));
  setText('kpiPeak', `${monthLabelYYYYMM(D.summary.peak_month)} — ${CLP.format(D.summary.peak_ingreso)} (${fmtInt(D.summary.peak_activas)} activas)`);

  // Mix de plazos
  const mix = D.summary.mix_plazo; // {24: x, 12: y}
  const mixTotal = (mix[24]||0) + (mix[12]||0);
  const p24 = mixTotal ? (mix[24]||0)/mixTotal : 0; const p12 = mixTotal ? (mix[12]||0)/mixTotal : 0;
  setText('kpiMix', `${(p24*100).toFixed(1)}% · ${(p12*100).toFixed(1)}%`);
  setText('kpiMixNote', `24m = ${fmtInt(mix[24]||0)} | 12m = ${fmtInt(mix[12]||0)} (total ${fmtInt(mixTotal)})`);

  // Activas por plazo (mes actual)
  const ap = D.summary.actives_plazo_current; const apTotal = (ap[24]||0)+(ap[12]||0);
  setText('kpiActivasPlazo', `${((ap[24]||0)/apTotal*100).toFixed(1)}% · ${((ap[12]||0)/apTotal*100).toFixed(1)}%`);
  setText('kpiActivasPlazoNote', `24m = ${fmtInt(ap[24]||0)} | 12m = ${fmtInt(ap[12]||0)} (total ${fmtInt(apTotal)})`);

  // ==== Gráficos ====
  setText('ingresosRange', `${months[0]} – ${months[months.length-1]}`);
  setText('ventasRange', `${months[0]} – ${months[months.length-1]}`);
  setText('mesActual', currentLabel);
  setText('mesActual2', currentLabel);

  // Ingresos mensuales
  (function(){
    const el = document.getElementById('ingresosChart'); if(!el) return;
    const ctx1 = el.getContext('2d');
    new Chart(ctx1, {
      type: 'line',
      data: { labels: months, datasets: [{ label: 'Ingreso mensual (CLP)', data: D.series.ingreso, borderWidth: 2, tension: 0.25, pointRadius: 2 }] },
      options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
  })();

  // Ventas (barras) y Cancelaciones (línea)
  (function(){
    const el = document.getElementById('ventasChart'); if(!el) return;
    const ctx2 = el.getContext('2d');
    new Chart(ctx2, {
      type: 'bar',
      data: { labels: months, datasets: [
        { label: 'Ventas (# pólizas)', data: D.series.ventas },
        { label: 'Cancelaciones (#)', type: 'line', data: D.series.cancelaciones, borderWidth: 2, tension: 0.25, pointRadius: 2 }
      ] },
      options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } }
    });
  })();

  // ==== Tablas ====
  // Responsables
  (function(){
    const respBody = document.getElementById('respBody'); if(!respBody) return;
    const rows = D.tables.responsables_mes_actual || [];
    if(!rows.length){
      const tr = document.createElement('tr'); tr.innerHTML = `<td class="p-2" colspan="4"><span class="muted">Sin datos</span></td>`; respBody.appendChild(tr); return;
    }
    for(const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-2">${r.gt}</td>
        <td class="p-2">${r.bci}</td>
        <td class="p-2 text-right">${fmtInt(r.polizas)}</td>
        <td class="p-2 text-right">${CLP.format(r.ingreso)}</td>
      `;
      respBody.appendChild(tr);
    }
  })();

  // Canales (desde glosa "Nombre del Canal")
  (function(){
    const dealerBody = document.getElementById('dealerBody'); if(!dealerBody) return;
    const canalRows = (D.tables.canal_mes_actual || D.tables.dealer_mes_actual) || [];
    if(!canalRows.length){
      const tr = document.createElement('tr'); tr.innerHTML = `<td class="p-2" colspan="3"><span class="muted">Sin datos</span></td>`; dealerBody.appendChild(tr); return;
    }
    for (const d of canalRows) {
      const nombre = d.canal || d.dealer || '-';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-2">${nombre}</td>
        <td class="p-2 text-right">${fmtInt(d.polizas)}</td>
        <td class="p-2 text-right">${CLP.format(d.ingreso)}</td>
      `;
      dealerBody.appendChild(tr);
    }
  })();

  // Cascada mensual
  (function(){
    const cascadaBody = document.getElementById('cascadaBody'); if(!cascadaBody) return;
    const rows = D.tables.cascada_mensual || [];
    for(const d of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="p-2">${d.label}</td>
        <td class="p-2 text-right">${CLP.format(d.ingreso)}</td>
        <td class="p-2 text-right">${fmtInt(d.activas)}</td>
        <td class="p-2 text-right">${fmtInt(d.ventas)}</td>
        <td class="p-2 text-right">${fmtInt(d.cancelaciones || 0)}</td>
      `;
      cascadaBody.appendChild(tr);
    }
  })();

  
  // ====== Extensión v2: Controles (simplificados) y Cohortes (oct-2025) ======
  (function(){
    const D = window.__DATA__;
    if(!D || !D.series) return;
    const CLP = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });
    const fmtInt = (n) => new Intl.NumberFormat('es-CL').format(n);
    const months = D.series.months.slice();
    const baseIngreso = D.series.ingreso.slice();
    const baseVentas = D.series.ventas.slice();
    const baseCancel = D.series.cancelaciones.slice();
    const labelIndex = new Map(months.map((l,i)=>[l,i]));
    const currentKey = D.current_month; // 'YYYY-MM'
    const currentLabel = ((k)=>{ const [y,m]=k.split('-'); return `${m}/${y}`; })(currentKey);
    const currentIdx = labelIndex.get(currentLabel) ?? months.length-1;

    // ===== Insertar Controles arriba de gráficos (solo botones solicitados)
    const chartsSection = document.getElementById('chartsSection');
    if(!chartsSection || !chartsSection.parentNode) return;
    const controls = document.createElement('section');
    controls.className = 'card p-4';
    controls.innerHTML = `
      <div class="flex items-center justify-between mb-1">
        <h3 class="font-medium">Controles de vista y proyección</h3>
        <div class="flex flex-wrap gap-2 text-xs">
          <button data-range="all" class="px-2 py-1 rounded border">Todo</button>
          <button data-range="last12" class="px-2 py-1 rounded border">Últimos 12m</button>
          <button data-range="ytd" class="px-2 py-1 rounded border">YTD</button>
          <button data-range="next12" class="px-2 py-1 rounded border">Próx. 12m</button>
          <button data-range="reset" class="px-2 py-1 rounded border">Reset</button>
        </div>
      </div>
      <div class="text-xs muted">Usa los atajos para acotar el rango; los gráficos y la tabla se actualizan al instante.</div>
    `;
    chartsSection.parentNode.insertBefore(controls, chartsSection);

    // ===== Estado de rango y helpers
    let rangeStart = 0;
    let rangeEnd = months.length-1;
    function setRange(kind){
      if(kind==='all' || kind==='reset'){ rangeStart = 0; rangeEnd = months.length-1; }
      if(kind==='last12'){
        const end = Math.max(0, Math.min(months.length-1, currentIdx));
        const start = Math.max(0, end-11);
        rangeStart = start; rangeEnd = end;
      }
      if(kind==='ytd'){
        const cy = currentKey.split('-')[0];
        const yStart = labelIndex.get(`01/${cy}`) ?? 0;
        rangeStart = yStart; rangeEnd = Math.max(yStart, currentIdx);
      }
      if(kind==='next12'){
        const start = Math.min(months.length-1, currentIdx);
        const end = Math.min(months.length-1, start+11);
        rangeStart = start; rangeEnd = end;
      }
      applyView();
    }
    controls.querySelectorAll('button[data-range]').forEach(b=> b.addEventListener('click', ()=> setRange(b.getAttribute('data-range'))));

    // ===== Render según rango
    function applyView(){
      const i0 = rangeStart, i1 = rangeEnd;
      const labels = months.slice(i0, i1+1);
      const ingreso = baseIngreso.slice(i0, i1+1);
      const ventas = baseVentas.slice(i0, i1+1);
      const cancel = baseCancel.slice(i0, i1+1);

      // Rebuild ingresos chart
      const cv1 = document.getElementById('ingresosChart');
      if(cv1){
        const ex1 = (window.Chart && window.Chart.getChart) ? Chart.getChart(cv1) : null; if(ex1) ex1.destroy();
        const ctx1 = cv1.getContext('2d');
        new Chart(ctx1, { type: 'line', data: { labels, datasets: [{ label: 'Ingreso mensual (CLP)', data: ingreso, borderWidth: 2, tension: 0.25, pointRadius: 2 }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
      }

      // Rebuild ventas chart
      const cv2 = document.getElementById('ventasChart');
      if(cv2){
        const ex2 = (window.Chart && window.Chart.getChart) ? Chart.getChart(cv2) : null; if(ex2) ex2.destroy();
        const ctx2 = cv2.getContext('2d');
        new Chart(ctx2, { type: 'bar', data: { labels, datasets: [ { label: 'Ventas (# pólizas)', data: ventas }, { label: 'Cancelaciones (#)', type: 'line', data: cancel, borderWidth: 2, tension: 0.25, pointRadius: 2 } ] }, options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true } } } });
      }

      // Rango visible en labels
      const r1 = document.getElementById('ingresosRange'); if(r1) r1.textContent = `${labels[0]} – ${labels[labels.length-1]}`;
      const r2 = document.getElementById('ventasRange'); if(r2) r2.textContent = `${labels[0]} – ${labels[labels.length-1]}`;

      // Tabla cascada dentro del rango
      const tbody = document.getElementById('cascadaBody');
      if(tbody){
        tbody.innerHTML = '';
        for(let i=i0;i<=i1;i++){
          const m = D.tables.cascada_mensual[i];
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="p-2">${m.label}</td>
            <td class="p-2 text-right">${CLP.format(m.ingreso)}</td>
            <td class="p-2 text-right">${fmtInt(m.activas)}</td>
            <td class="p-2 text-right">${fmtInt(m.ventas)}</td>
            <td class="p-2 text-right">${fmtInt(m.cancelaciones||0)}</td>
          `;
          tbody.appendChild(tr);
        }
      }
    }

    // Render inicial (todo)
    applyView();

    // (Cohortes) Eliminado a solicitud: no se renderiza la tabla de cohortes.
  })();

  // ===== Autotest (debug): valida nodos críticos en DOM
  (function(){
    const mustHave = ['ingresosChart','ventasChart','respBody','dealerBody','cascadaBody'];
    const missing = mustHave.filter(id=>!document.getElementById(id));
    if(missing.length){ console.warn('Dashboard: elementos faltantes en DOM:', missing); }
  })();
</script>
</body>
</html>
