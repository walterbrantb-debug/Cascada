<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Garantía Total — Dashboard de Ingresos (Cascada)</title>
  <meta name="description" content="Tablero estático con KPIs, cascada de ingresos y desgloses por responsables y dealers. Datos embebidos desde la base de conocimiento (oct-2025)." />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body { height: 100%; }
    .card { border-radius: 1rem; background: white; box-shadow: 0 1px 3px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04); }
    .muted { color: #6b7280; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .sticky-thead thead { position: sticky; top: 0; background: white; }
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 border-b">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-emerald-600 flex items-center justify-center text-white font-bold">GT</div>
        <div>
          <h1 class="text-xl font-semibold">Dashboard de Ingresos — Cascada</h1>
          <p class="text-sm muted">Garantías Extendidas | Reconocimiento lineal: <span class="mono">$6.250</span> / póliza / mes</p>
        </div>
      </div>
      <div class="text-xs muted">Corte: <span id="corte"></span> · Rango: <span id="rango"></span></div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- KPIs macro -->
    <section class="grid md:grid-cols-4 gap-4">
      <div class="card p-4">
        <div class="text-sm muted">Ingreso realizado (hasta fin de mes previo)</div>
        <div id="kpiRealizado" class="text-2xl font-semibold mt-1">—</div>
        <div id="kpiRealizadoNote" class="text-xs muted mt-1">—</div>
      </div>
      <div class="card p-4">
        <div class="text-sm muted">Backlog (desde mes actual)</div>
        <div id="kpiBacklog" class="text-2xl font-semibold mt-1">—</div>
        <div id="kpiBacklogNote" class="text-xs muted mt-1">—</div>
      </div>
      <div class="card p-4">
        <div class="text-sm muted">Run‑rate mes actual</div>
        <div id="kpiRunRate" class="text-2xl font-semibold mt-1">—</div>
        <div class="text-xs muted mt-1">Pólizas activas: <span id="kpiActivas"></span></div>
      </div>
      <div class="card p-4">
        <div class="text-sm muted">Tasa de cancelación (acumulada)</div>
        <div id="kpiCancelRate" class="text-2xl font-semibold mt-1">—</div>
        <div class="text-xs muted mt-1"># canceladas: <span id="kpiCancelCount"></span> / total: <span id="kpiTotalPolicies"></span></div>
      </div>
    </section>

    <!-- KPIs secundarios -->
    <section class="grid md:grid-cols-3 gap-4">
      <div class="card p-4">
        <div class="text-sm muted">Mes pico (ingreso)</div>
        <div id="kpiPeak" class="text-2xl font-semibold mt-1">—</div>
      </div>
      <div class="card p-4">
        <div class="text-sm muted">Mix de plazos (ventas)</div>
        <div id="kpiMix" class="text-2xl font-semibold mt-1">—</div>
        <div class="text-xs muted mt-1" id="kpiMixNote"></div>
      </div>
      <div class="card p-4">
        <div class="text-sm muted">Activas mes actual por plazo</div>
        <div id="kpiActivasPlazo" class="text-2xl font-semibold mt-1">—</div>
        <div class="text-xs muted mt-1" id="kpiActivasPlazoNote"></div>
      </div>
    </section>

    <!-- Trend macro -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-medium">Ingresos mensuales</h3>
          <div class="text-xs muted" id="ingresosRange">—</div>
        </div>
        <canvas id="ingresosChart" height="220"></canvas>
      </div>
      <div class="card p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-medium">Pólizas: ventas y cancelaciones</h3>
          <div class="text-xs muted" id="ventasRange">—</div>
        </div>
        <canvas id="ventasChart" height="220"></canvas>
      </div>
    </section>

    <!-- Micro: desgloses del mes actual -->
    <section class="grid md:grid-cols-2 gap-4">
      <div class="card p-4 overflow-hidden">
        <div class="flex items-center justify-between">
          <h3 class="font-medium">Desglose por Responsable (mes actual)</h3>
          <div class="text-xs muted" id="mesActual"></div>
        </div>
        <div class="overflow-auto max-h-[360px]">
          <table class="w-full text-sm sticky-thead">
            <thead>
              <tr>
                <th class="text-left p-2">Responsable GT</th>
                <th class="text-left p-2">Responsable Bci</th>
                <th class="text-right p-2">Pólizas</th>
                <th class="text-right p-2">Ingreso</th>
              </tr>
            </thead>
            <tbody id="respBody"></tbody>
          </table>
        </div>
      </div>
      <div class="card p-4 overflow-hidden">
        <div class="flex items-center justify-between">
          <h3 class="font-medium">Top dealers (mes actual)</h3>
          <div class="text-xs muted" id="mesActual2"></div>
        </div>
        <div class="overflow-auto max-h-[360px]">
          <table class="w-full text-sm sticky-thead">
            <thead>
              <tr>
                <th class="text-left p-2">Dealer / Punto de Venta</th>
                <th class="text-right p-2">Pólizas</th>
                <th class="text-right p-2">Ingreso</th>
              </tr>
            </thead>
            <tbody id="dealerBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Cascada completa -->
    <section class="card p-4">
      <div class="flex items-center justify-between">
        <h3 class="font-medium">Cascada por mes (historia + proyección cartera vigente)</h3>
        <button id="downloadCsvBtn" class="px-3 py-2 rounded-xl bg-gray-900 text-white text-sm">Descargar CSV</button>
      </div>
      <div class="overflow-auto max-h-[420px] mt-2">
        <table class="w-full text-sm sticky-thead">
          <thead>
            <tr>
              <th class="text-left p-2">Mes</th>
              <th class="text-right p-2">Ingreso</th>
              <th class="text-right p-2">Activas</th>
              <th class="text-right p-2">Ventas</th>
              <th class="text-right p-2">Cancelaciones</th>
            </tr>
          </thead>
          <tbody id="cascadaBody"></tbody>
        </table>
      </div>
    </section>

    <footer class="text-xs muted">
      <p>Hecho para <strong>Garantía Total</strong>. Datos embebidos al <span id="dataDate"></span>. Supuestos: precio 12m = $75.000; 24m = $150.000; reconocimiento lineal = $6.250/mes; cancelaciones cortan ingreso desde el mes de <em>FECHA_FIN</em> (excluyente).</p>
    </footer>
  </main>

<script>
  // ==== Datos embebidos desde la base de conocimiento (oct-2025) ====
  window.__DATA__ = {"current_month": "2025-10", "series": {"months": ["02/2025", "03/2025", "04/2025", "05/2025", "06/2025", "07/2025", "08/2025", "09/2025", "10/2025", "11/2025", "12/2025", "01/2026", "02/2026", "03/2026", "04/2026", "05/2026", "06/2026", "07/2026", "08/2026", "09/2026", "10/2026", "11/2026", "12/2026", "01/2027", "02/2027", "03/2027", "04/2027", "05/2027", "06/2027", "07/2027", "08/2027", "09/2027"], "ingreso": [187500, 531250, 1093750, 1593750, 1950000, 2018750, 2425000, 3137500, 2950000, 2950000, 2950000, 2950000, 2950000, 2950000, 2950000, 2950000, 2950000, 2950000, 2950000, 2950000, 2950000, 2950000, 2950000, 2500000, 2031250, 1606250, 1181250, 931250, 693750, 487500, 250000, 62500], "activas": [30, 85, 175, 255, 312, 323, 388, 502, 472, 472, 472, 472, 472, 472, 472, 472, 472, 472, 472, 472, 472, 472, 472, 400, 325, 257, 189, 149, 111, 78, 40, 10], "ventas": [30, 55, 90, 80, 57, 11, 65, 114, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], "cancelaciones": [0, 3, 6, 8, 10, 8, 9, 13, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]}, "summary": {"realized": 8925000, "backlog": 60300000, "run_rate": 2950000, "active_now": 472, "cancel_rate": 0.14025500910746813, "cancel_count": 77, "total_policies": 549, "peak_month": "2025-09", "peak_ingreso": 3137500, "peak_activas": 502, "mix_plazo": {"24": 510, "12": 39}, "actives_plazo_current": {"24": 435, "12": 37}}, "tables": {"responsables_mes_actual": [{"gt": "Paola Crisosto", "bci": "Aldo", "polizas": 159, "ingreso": 993750}, {"gt": "Jeannette Guerrero", "bci": "Pamela", "polizas": 120, "ingreso": 750000}, {"gt": "", "bci": "", "polizas": 108, "ingreso": 675000}, {"gt": "Paola Crisosto", "bci": "Pamela", "polizas": 36, "ingreso": 225000}, {"gt": "Jeannette Guerrero", "bci": "Aldo", "polizas": 23, "ingreso": 143750}, {"gt": "Paola Crisosto", "bci": null, "polizas": 22, "ingreso": 137500}, {"gt": "Jeannette Guerrero", "bci": null, "polizas": 4, "ingreso": 25000}], "dealer_mes_actual": [{"dealer": "Seguro Automotriz Garantía Extendida GARCIA Y BLU", "polizas": 119, "ingreso": 743750}, {"dealer": "Seguro Automotriz Garantía Extendida E KOVACS CONCEPCION", "polizas": 118, "ingreso": 737500}, {"dealer": "Seguro Automotriz Garantía Extendida AUTOMOTORA DEL SUR", "polizas": 58, "ingreso": 362500}, {"dealer": "Seguro Automotriz Garantía Extendida IMPORTADORA Y COMERCIALIZADORA BGA CHILE SPA", "polizas": 56, "ingreso": 350000}, {"dealer": "Seguro Automotriz Garantía Extendida PROMOTORSCHILE", "polizas": 44, "ingreso": 275000}, {"dealer": "Seguro Automotriz Garantía Extendida ESCA SAS", "polizas": 31, "ingreso": 193750}, {"dealer": "Seguro Automotriz Garantía Extendida LA VELOCE", "polizas": 22, "ingreso": 137500}, {"dealer": "Seguro Automotriz Garantía Extendida AUTOMOTORA SOCOE", "polizas": 7, "ingreso": 43750}, {"dealer": "Seguro Automotriz Garantía Extendida SUMMITCARS", "polizas": 6, "ingreso": 37500}, {"dealer": "Seguro Automotriz Garantía Extendida JMT AUTOMOTORES", "polizas": 6, "ingreso": 37500}, {"dealer": "Seguro Automotriz Garantía Extendida MUALDA", "polizas": 4, "ingreso": 25000}, {"dealer": "Seguro Automotriz Garantía Extendida AUTOCENTRO LOBAR LTD", "polizas": 3, "ingreso": 18750}, {"dealer": "Seguro Automotriz Garantía Extendida AUTOMOTORA DOS HERMANOS", "polizas": 2, "ingreso": 12500}, {"dealer": "Seguro Automotriz Garantía Extendida AUTOMOTORA VILLASECA", "polizas": 2, "ingreso": 12500}, {"dealer": "Seguro Automotriz Garantía Extendida E KOVACS TALCAHUANO", "polizas": 1, "ingreso": 6250}, {"dealer": "Seguro Automotriz Garantía Extendida AUTOXPARTS", "polizas": 1, "ingreso": 6250}], "cascada_mensual": [{"label": "02/2025", "ingreso": 187500, "activas": 30, "ventas": 30, "cancelaciones": 0}, {"label": "03/2025", "ingreso": 531250, "activas": 85, "ventas": 55, "cancelaciones": 3}, {"label": "04/2025", "ingreso": 1093750, "activas": 175, "ventas": 90, "cancelaciones": 6}, {"label": "05/2025", "ingreso": 1593750, "activas": 255, "ventas": 80, "cancelaciones": 8}, {"label": "06/2025", "ingreso": 1950000, "activas": 312, "ventas": 57, "cancelaciones": 10}, {"label": "07/2025", "ingreso": 2018750, "activas": 323, "ventas": 11, "cancelaciones": 8}, {"label": "08/2025", "ingreso": 2425000, "activas": 388, "ventas": 65, "cancelaciones": 9}, {"label": "09/2025", "ingreso": 3137500, "activas": 502, "ventas": 114, "cancelaciones": 13}, {"label": "10/2025", "ingreso": 2950000, "activas": 472, "ventas": 0, "cancelaciones": 10}, {"label": "11/2025", "ingreso": 2950000, "activas": 472, "ventas": 0, "cancelaciones": 0}, {"label": "12/2025", "ingreso": 2950000, "activas": 472, "ventas": 0, "cancelaciones": 0}, {"label": "01/2026", "ingreso": 2950000, "activas": 472, "ventas": 0, "cancelaciones": 0}, {"label": "02/2026", "ingreso": 2950000, "activas": 472, "ventas": 0, "cancelaciones": 0}, {"label": "03/2026", "ingreso": 2950000, "activas": 472, "ventas": 0, "cancelaciones": 0}, {"label": "04/2026", "ingreso": 2950000, "activas": 472, "ventas": 0, "cancelaciones": 0}, {"label": "05/2026", "ingreso": 2950000, "activas": 472, "ventas": 0, "cancelaciones": 0}, {"label": "06/2026", "ingreso": 2950000, "activas": 472, "ventas": 0, "cancelaciones": 0}, {"label": "07/2026", "ingreso": 2950000, "activas": 472, "ventas": 0, "cancelaciones": 0}, {"label": "08/2026", "ingreso": 2950000, "activas": 472, "ventas": 0, "cancelaciones": 0}, {"label": "09/2026", "ingreso": 2950000, "activas": 472, "ventas": 0, "cancelaciones": 0}, {"label": "10/2026", "ingreso": 2950000, "activas": 472, "ventas": 0, "cancelaciones": 0}, {"label": "11/2026", "ingreso": 2950000, "activas": 472, "ventas": 0, "cancelaciones": 0}, {"label": "12/2026", "ingreso": 2950000, "activas": 472, "ventas": 0, "cancelaciones": 0}, {"label": "01/2027", "ingreso": 2500000, "activas": 400, "ventas": 0, "cancelaciones": 0}, {"label": "02/2027", "ingreso": 2031250, "activas": 325, "ventas": 0, "cancelaciones": 0}, {"label": "03/2027", "ingreso": 1606250, "activas": 257, "ventas": 0, "cancelaciones": 0}, {"label": "04/2027", "ingreso": 1181250, "activas": 189, "ventas": 0, "cancelaciones": 0}, {"label": "05/2027", "ingreso": 931250, "activas": 149, "ventas": 0, "cancelaciones": 0}, {"label": "06/2027", "ingreso": 693750, "activas": 111, "ventas": 0, "cancelaciones": 0}, {"label": "07/2027", "ingreso": 487500, "activas": 78, "ventas": 0, "cancelaciones": 0}, {"label": "08/2027", "ingreso": 250000, "activas": 40, "ventas": 0, "cancelaciones": 0}, {"label": "09/2027", "ingreso": 62500, "activas": 10, "ventas": 0, "cancelaciones": 0}]}};

  // ==== Utilidades ====
  const CLP = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });
  const PCT = new Intl.NumberFormat('es-CL', { style: 'percent', minimumFractionDigits: 1, maximumFractionDigits: 1 });
  const fmtInt = (n) => new Intl.NumberFormat('es-CL').format(n);

  function setText(id, value){ const el = document.getElementById(id); if(el) el.textContent = value; }

  function monthLabelYYYYMM(key){
    const [y,m] = key.split('-'); return `${m}/${y}`;
  }

  // ==== Render KPIs ====
  const D = window.__DATA__;
  const months = D.series.months; // 'mm/yyyy'
  const currentKey = D.current_month; // 'YYYY-MM'
  const currentLabel = monthLabelYYYYMM(currentKey);

  // Cabecera
  setText('corte', new Date('2025-10-03').toLocaleDateString('es-CL'));
  setText('rango', `${months[0]} – ${months[months.length-1]}`);
  setText('dataDate', '03/oct/2025');

  // KPIs
  setText('kpiRealizado', CLP.format(D.summary.realized));
  setText('kpiRealizadoNote', `Hasta ${monthLabelYYYYMM('2025-09')}`);
  setText('kpiBacklog', CLP.format(D.summary.backlog));
  setText('kpiBacklogNote', `Desde ${currentLabel}`);
  setText('kpiRunRate', CLP.format(D.summary.run_rate));
  setText('kpiActivas', fmtInt(D.summary.active_now));
  setText('kpiCancelRate', PCT.format(D.summary.cancel_rate));
  setText('kpiCancelCount', fmtInt(D.summary.cancel_count));
  setText('kpiTotalPolicies', fmtInt(D.summary.total_policies));
  setText('kpiPeak', `${monthLabelYYYYMM(D.summary.peak_month)} — ${CLP.format(D.summary.peak_ingreso)} (${fmtInt(D.summary.peak_activas)} activas)`);

  // Mix de plazos
  const mix = D.summary.mix_plazo; // {24: x, 12: y}
  const mixTotal = (mix[24]||0) + (mix[12]||0);
  const p24 = mixTotal ? (mix[24]||0)/mixTotal : 0; const p12 = mixTotal ? (mix[12]||0)/mixTotal : 0;
  setText('kpiMix', `${(p24*100).toFixed(1)}% · ${(p12*100).toFixed(1)}%`);
  setText('kpiMixNote', `24m = ${fmtInt(mix[24]||0)} | 12m = ${fmtInt(mix[12]||0)} (total ${fmtInt(mixTotal)})`);

  // Activas por plazo (mes actual)
  const ap = D.summary.actives_plazo_current; const apTotal = (ap[24]||0)+(ap[12]||0);
  setText('kpiActivasPlazo', `${((ap[24]||0)/apTotal*100).toFixed(1)}% · ${((ap[12]||0)/apTotal*100).toFixed(1)}%`);
  setText('kpiActivasPlazoNote', `24m = ${fmtInt(ap[24]||0)} | 12m = ${fmtInt(ap[12]||0)} (total ${fmtInt(apTotal)})`);

  // ==== Gráficos ====
  setText('ingresosRange', `${months[0]} – ${months[months.length-1]}`);
  setText('ventasRange', `${months[0]} – ${months[months.length-1]}`);
  setText('mesActual', currentLabel);
  setText('mesActual2', currentLabel);

  // Ingresos mensuales
  const ctx1 = document.getElementById('ingresosChart').getContext('2d');
  new Chart(ctx1, {
    type: 'line',
    data: { labels: months, datasets: [{ label: 'Ingreso mensual (CLP)', data: D.series.ingreso, borderWidth: 2, tension: 0.25, pointRadius: 2 }] },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
  });

  // Ventas (barras) y Cancelaciones (línea)
  const ctx2 = document.getElementById('ventasChart').getContext('2d');
  new Chart(ctx2, {
    type: 'bar',
    data: { labels: months, datasets: [
      { label: 'Ventas (# pólizas)', data: D.series.ventas },
      { label: 'Cancelaciones (#)', type: 'line', data: D.series.cancelaciones, borderWidth: 2, tension: 0.25, pointRadius: 2 }
    ] },
    options: { responsive: true, scales: { y: { beginAtZero: true } } }
  });

  // ==== Tablas ====
  // Responsables
  const respBody = document.getElementById('respBody');
  for(const r of D.tables.responsables_mes_actual){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2">${r.gt}</td>
      <td class="p-2">${r.bci}</td>
      <td class="p-2 text-right">${fmtInt(r.polizas)}</td>
      <td class="p-2 text-right">${CLP.format(r.ingreso)}</td>
    `;
    respBody.appendChild(tr);
  }

  // Dealers
  const dealerBody = document.getElementById('dealerBody');
  for(const d of D.tables.dealer_mes_actual){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2">${d.dealer}</td>
      <td class="p-2 text-right">${fmtInt(d.polizas)}</td>
      <td class="p-2 text-right">${CLP.format(d.ingreso)}</td>
    `;
    dealerBody.appendChild(tr);
  }

  // Cascada mensual
  const cascadaBody = document.getElementById('cascadaBody');
  for(const d of D.tables.cascada_mensual){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="p-2">${d.label}</td>
      <td class="p-2 text-right">${CLP.format(d.ingreso)}</td>
      <td class="p-2 text-right">${fmtInt(d.activas)}</td>
      <td class="p-2 text-right">${fmtInt(d.ventas)}</td>
      <td class="p-2 text-right">${fmtInt(d.cancelaciones || 0)}</td>
    `;
    cascadaBody.appendChild(tr);
  }

  // Descargar CSV
  document.getElementById('downloadCsvBtn').addEventListener('click', () => {
    const lines = ['mes,ingreso,activas,ventas,cancelaciones'];
    for(let i=0;i<D.series.months.length;i++){
      lines.push(`${D.series.months[i]},${D.series.ingreso[i]},${D.series.activas[i]},${D.series.ventas[i]},${D.series.cancelaciones[i]}`);
    }
    const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'cascada_mensual.csv'; a.click(); URL.revokeObjectURL(url);
  });
</script>
</body>
</html>
